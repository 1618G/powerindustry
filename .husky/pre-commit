#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# 1. Check for stub code
echo "  â”œâ”€ Checking for stub code..."
pnpm detect-stubs:strict
if [ $? -ne 0 ]; then
  echo "  â”‚  âŒ Stub code detected! Remove stub code before committing."
  echo "  â”‚  Run 'pnpm detect-stubs' for details."
  exit 1
fi
echo "  â”‚  âœ… No stub code found"

# 2. TypeScript check
echo "  â”œâ”€ Running TypeScript check..."
pnpm typecheck
if [ $? -ne 0 ]; then
  echo "  â”‚  âŒ TypeScript errors found! Fix them before committing."
  exit 1
fi
echo "  â”‚  âœ… TypeScript check passed"

# 3. Lint staged files
echo "  â”œâ”€ Running ESLint on staged files..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo "  â”‚  âŒ ESLint errors found! Fix them before committing."
  exit 1
fi
echo "  â”‚  âœ… ESLint passed"

# 4. Check for dead code (optional - can be slow)
if [ "$SKIP_DEAD_CODE_CHECK" != "1" ]; then
  echo "  â”œâ”€ Checking for dead code..."
  pnpm dead-code:check 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "  â”‚  âš ï¸  Dead code detected. Run 'pnpm dead-code' for details."
    echo "  â”‚  Set SKIP_DEAD_CODE_CHECK=1 to skip this check."
    # Warning only, don't block commit
  else
    echo "  â”‚  âœ… No dead code detected"
  fi
fi

# 5. Check for secrets
echo "  â””â”€ Checking for exposed secrets..."
if git diff --cached --name-only | xargs grep -l -E "(sk-[a-zA-Z0-9]{20,}|AKIA[A-Z0-9]{16}|ghp_[a-zA-Z0-9]{36})" 2>/dev/null; then
  echo "     âŒ Potential secrets detected in staged files!"
  echo "     Review and remove any API keys, tokens, or credentials."
  exit 1
fi
echo "     âœ… No exposed secrets found"

echo ""
echo "âœ… All pre-commit checks passed!"
